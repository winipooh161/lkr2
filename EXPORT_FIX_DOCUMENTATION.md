# Исправление проблемы экспорта элементов разделов в сметах

## Описание проблемы

**Симптомы:** При экспорте смет в PDF и Excel новые разделы отображаются, но строки внутри этих разделов не появляются в экспортированных файлах.

**Причина:** В коде экспорта (`EstimateJsonExportService.php`) использовалось условие `!isset($item['is_header'])`, которое проверяло отсутствие поля `is_header`. Однако новые элементы в JSON имеют поле `"is_header": false`, что делало условие ложным.

## Техническое объяснение

### Структура данных

Старые элементы в JSON:
```json
{
    "name": "Название элемента",
    "cost": 1000
    // поле is_header отсутствует
}
```

Новые элементы в JSON:
```json
{
    "name": "Название элемента", 
    "cost": 1000,
    "is_header": false  // поле присутствует!
}
```

### Проблемное условие

**До исправления:**
```php
if (is_array($item) && !empty($item) && !isset($item['is_header'])) {
    // Обрабатываем элемент
}
```

**После исправления:**
```php
if (is_array($item) && !empty($item) && (!isset($item['is_header']) || $item['is_header'] === false)) {
    // Обрабатываем элемент
}
```

## Внесенные изменения

### Файл: `app/Services/EstimateJsonExportService.php`

1. **Строка ~252** - Основной цикл обработки элементов для Excel
2. **Строка ~484** - Подсчет строк для стилизации Excel
3. **Строка ~628** - Генерация HTML для PDF

### Исправленное условие

Теперь элемент включается в экспорт если:
- Поле `is_header` отсутствует (старые элементы), ИЛИ
- Поле `is_header` равно `false` (новые элементы)

Элементы с `"is_header": true` по-прежнему исключаются из экспорта.

## Тестирование

Создан файл диагностики: `public_html/js/estimates/debug-export-fix.js`

### Использование:
1. Откройте страницу редактирования сметы
2. Откройте консоль браузера (F12)
3. Выполните: `window.debugExportFix.analyze()`

### Проверка экспорта:
Протестируйте все форматы экспорта для сметы #60:
- `/partner/estimates/60/export` (Excel полный)
- `/partner/estimates/60/export-client` (Excel для клиента)
- `/partner/estimates/60/export-contractor` (Excel для мастера)
- `/partner/estimates/60/export-pdf` (PDF полный)
- `/partner/estimates/60/export-pdf-client` (PDF для клиента)
- `/partner/estimates/60/export-pdf-contractor` (PDF для мастера)

## Логирование

Добавлено расширенное логирование в метод `addDataToSheet()` для отслеживания:
- Количества обрабатываемых разделов
- Подробной информации о каждом разделе
- Образцов данных элементов

Логи можно просмотреть в `storage/logs/laravel.log`.

## Дата исправления
12 июля 2025 г.
